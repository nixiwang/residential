---
title: "Agenda"
author: "Yohan Min"
date: "November 30, 2018"
output:
  html_document:
    keep_md: yes
    preserve_yaml: yes
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE, echo= F}
knitr::opts_chunk$set(echo = FALSE, warning= F, message= F, fig.align="center")
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(forcats)
library(pander)
library(stringr)
library(psych)
library (cluster)
library(reshape)
library(reshape2)
library(som)
library(GPArotation)
library(corrplot)
library(tibble)
library(GGally)
# library(MASS)
```

## Risk per full-time workers
![Top 3 risks are related to solar installation on the roof](./Figs/PTD.jpg)

## Ideal design for safety from the interviews
* Roof pitch: lower than 5/12 â€“ 7/12 `to work easy - fall`
* Roof material: composition `not to be slippery - fall`
* Roof structure: no obstruction `not to be interrupted - trip, complexity`
* Roof condition: accessories pre-installed `to reduce the scope - complexity`
* Anchor point: pre-installed `to be efficient - fall`
* Access: low height, `enough space for easier access - fall`
* Additional: setback, snow guard, guardrail `fall`
* Electrical: micro inverter, conduit pre-run, reserving spaces, `electric shock, complexity`


## Solar installation trend in Seattle

```{r load data}
load("../data/derived/prj1.Rdata")
load("../data/derived/prj2.Rdata")
load("../data/derived/prj3.Rdata")
```

```{r}

inst %>%
  mutate(year = year(CompletedDate)) %>%
  group_by(Class, year) %>%
  summarise(install = n()) %>%
  ggplot(aes(x = year, y = install, group = Class, color = Class))+
  geom_line(size = 1)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.90, 0.25),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))
```

## Solar installation trend by contractors

```{r}
inst %>%
  mutate(year = year(CompletedDate)) %>%
  group_by(Installer, year) %>%
  summarise(install = n()) %>%
  arrange(desc(install)) %>%
  left_join(top, by = c("Installer")) %>%
  filter(`top installer` == "Y") %>%
  ggplot(aes(x = year, y = install, group = Installer,
             color = Installer))+
  geom_line(size = 1)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))
```


## Cumulative solar installation per census track

```{r}
temp_spatial %>%
  filter(date > as.Date("01/01/2005", "%m/%d/%Y")) %>%
  ggplot(aes(x = date, y = sum, group = geoid, color = `Over 20`))+
  geom_line(size = 1, alpha = 0.4)+
  scale_color_manual(name ="Above 20 installation", values = c("red", "black"))+
  xlab("Year") + ylab("Cumulative number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")
```


## Residential household in Seattle

```{r, dev="svg", fig.height=4}
ggplot(pot, aes(x = `Income class`, y = hh_prp, group = geoid, color = `Income class`)) +
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5)) +
  theme_bw() + ylab("Household proportion") +
  theme(legend.position = c(0.8, 0.3),
                     legend.background = element_rect(color = 1))
```


## Residential solar potential (MWh) in Seattle

```{r, dev="svg", fig.height=4}
ggplot(pot, aes(x = `Income class`, y = `Total MWh`, group = geoid, color = `Income class`)) +
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) +
  theme_bw() + theme(legend.position = c(0.7, 0.3),
                     legend.background = element_rect(color = 1))
```

## Residential solar potential (MWh/ household) in Seattle

```{r, dev="svg", fig.height=4}
ggplot(pot, aes(x = `Income class`, y = `MWh/house hold`, group = geoid, color = `Income class`)) +
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) +
  theme_bw() + theme(legend.position = c(0.2, 0.3),
                     legend.background = element_rect(color = 1))
```


## Histograms of multiple variables

```{r, fig.height=5}
fhist <- regr[, c(-1, -11)]
par(mfrow=c(3,4))
for(i in 1:length(fhist)){
  hist(fhist[[i]], main= paste("Histogram of\n", names(fhist)[i]),
       xlab= names(fhist)[i], col="gold")
  abline(v = median(fhist[[i]]), col="red", lwd=4)
  text(median(fhist[[i]]), 0, round(median(fhist[[i]]),2), col = "blue")
}
```

## Boxplot for overall potential solar

```{r}
seattle %>%
  gather(class, mwh, very_low_mf_own_mwh:high_sf_rent_mwh) %>%
  select(geoid, class, mwh) %>%
  mutate(class = parse_factor(class, levels = names(seattle))) %>%
  mutate(cl = ifelse(str_detect(class, "verylow|low|mod"), "low",
                                 ifelse(str_detect(class, "mid"), "mid",
                                        ifelse(str_detect(class, "high"), "high", NA)))) %>%
  mutate(cl = parse_factor(cl, levels = c("low", "mid", "high"))) %>%
  ggplot(aes(x = class, y = mwh, color = class)) +
  geom_boxplot() +
  facet_wrap( ~ cl) +
  scale_y_log10() +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
      axis.ticks.x = element_blank())
```


## Cor plot

```{r}
### cor plot
regr_p <- regr %>%
  select(-geoid, -lihtc)

corrplot(cor(regr_p), method = "ellipse")
```


## Regression

```{r}
reg <- lm(sol_instl ~ .,regr[-c(1)])
# stepAIC(reg)

summary(lm(formula = sol_instl ~ hu_med_val + hu_ex_1000,
           data = regr[-c(1)]))
```

## Residual from the OLS
<center>

![OLS residual mapping](./Figs/OLS-resid.png){width=450px}

</center>

## Geographically weighted regression (GWR)
<center>

![Residual mapping for GWR](./Figs/GWR-resid.png){width=450px}

</center>

## Geographically weighted impact
<center>

![Impact of housing median value](./Figs/coef1.png){width=450px}

</center>

<center>

![impact of housing cost over $1k/ month](./Figs/coef2.png){width=450px}

</center>

<center>

![Solar installation hotspot](./Figs/hotspot.png){width=450px}

</center>

<center>

![Solar installation outlier](./Figs/outlier.png){width=450px}

</center>


## Factor analysis (Parallel screen)

```{r}
fct <- regr%>%
  select(-geoid, -sol_instl, -lihtc)

fa.parallel(fct,fa="fa",n.iter=50)
```

## Factor analysis (Plot)

```{r}
fa <- fa(fct,nfactors=3,rotate="promax",fm="ml")

factor.plot(fa, labels=rownames(fa$loadings))
```

## Factor analysis (Diagram)

```{r}
fa.diagram(fa,simple=T)
```

## Factor correlation for solar installation

```{r}
dat <- fa$scores
dim(dat)
plot(dat[,1], regr[[14]], xlab = "The 1st factor", ylab = "Solar installation")
```

## Factor regression
```{r}
summary(lm(regr[[14]] ~ dat[,1] + dat[,2] + dat[,3]))
```

## Cluster analysis
```{r}
set.seed(5099)
kme <- kmeans(dat,center=3)
table(kme$cluster) #number of samples in each cluster
Group1 <- kme$centers[1,]
Group2 <- kme$centers[2,]
plot(Group1,Group2,type="n")
text(Group1,Group2, labels=colnames(dat))
```

## Cluster within cluster sum of squares (WCSS)

```{r}
sum(kme$withinss)
wss <- (nrow(dat)-1)*sum(apply(dat,2,var))
for (i in 2:9) wss[i] <- sum(kmeans(dat,centers=i)$withinss)
plot(1:9, wss, type="b", xlab="Number of Clusters",ylab="Within groups sum of squares")
```

## Optimal cluster

```{r}

performance=c()
for (i in rep(1:100,times=30)) {
  clust=kmeans(dat,i)
  performance=c(performance,1-clust$tot.withinss/clust$totss)
}
perf_df=data.frame(metrics=performance,number_of_center=rep(1:100,times=30))
ggplot(perf_df,aes(x=number_of_center,y=metrics)) +
  geom_point(alpha=0.2) +
  geom_vline(xintercept = 3,color='red')

```

## Cluster plot
```{r}
pairs(dat, col=kme$cluster)
clusplot(dat, kme$cluster, color=TRUE,shade=TRUE, labels=5, lines=0)
```

## 3D plot
```{r}
library(rgl)
plot3d(fa$scores, col = kme$cluster)
```

![](./Figs/3D.jpg)

## Cluster with boxplot

```{r}
dat <- as.data.frame(dat)
dat$cluster=as.factor(kme$cluster)
ggpairs(dat, mapping=aes(color=cluster))+
  theme_bw()
```

## Cluster plot with smooth

```{r}
ggpairs(dat, columns = 1:3,
        aes(color=cluster, alpha=0.4),
        title="Scatterplot Matrix",
        upper=list(continuous="density", combo="box"),
        lower=list(continuous="smooth", combo="dot")) +
  theme_light() +
  theme(plot.title=element_text(size=10))+
  theme_bw()
```

## Data analysis 1

```{r}
c_reg <- regr
c_reg$cluster <- as.factor(kme$cluster)

c_reg %>%
  ggplot(aes(x = cluster, y = sol_instl, color = cluster)) +
  geom_boxplot() +
  ggtitle("Solar installation pattern per cluster")+
  theme_bw()

```


## Data analysis 2
```{r}

c_reg %>%
  ggplot(aes(x = hu_ex_1000, y = sol_instl, color = cluster, size = lihtc)) +
  geom_point() +
  ggtitle("Solar installation pattern per cluster")+
  theme_bw()
```

## Data analysis 3
```{r}
c_reg %>%
ggplot(aes(x = hu_med_val, y = sol_instl, color = cluster)) +
  geom_point(alpha = 0.4)+
  geom_smooth(span = 0.9)+
  theme_bw()
```

<center>

![Clustered census track](./Figs/cluster.png){width=450px}

</center>
