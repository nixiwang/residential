---
title: "Agenda"
author: "Yohan Min"
date: "November 26, 2018"
output: 
  html_document:
    preserve_yaml: true
    toc: true
    toc_float: true
    keep_md: true

---

```{r setup, include=FALSE, echo= F}
knitr::opts_chunk$set(echo = FALSE,warning= F, message= F)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(forcats)
library(pander)
library(stringr)
library(psych)
library (cluster)
library(reshape)
library(reshape2)
library(som)
library(GPArotation)
library(corrplot)
library(tibble)
library(MASS)

```

## R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Solar installation trend in Seattle

```{r load data}
load("../data/drived/wrk.Rdata")
load("../data/drived/install.Rdata")

elec %>% 
  mutate(year = year(CompletedDate)) %>% 
  group_by(Class, year) %>% 
  summarise(install = n()) %>% 
  ggplot(aes(x = year, y = install, group = Class, color = Class))+
  geom_line(size = 2)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.90, 0.25),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))
```

## Solar installation trend by contractors 

```{r}
elec %>% 
  mutate(year = year(CompletedDate)) %>% 
  group_by(Installer, year) %>% 
  summarise(install = n()) %>% 
  arrange(desc(install)) %>% 
  left_join(top, by = c("Installer")) %>% 
  filter(`top installer` == "Y") %>% 
  ggplot(aes(x = year, y = install, group = Installer, 
             color = Installer))+
  geom_line(size = 1)+
  xlab("Year") + ylab("Number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_continuous(breaks = seq(2000, 2019, by = 1))

```


## Cumulative solar installation per census track

```{r}
temp_spatial %>% 
  filter(date > as.Date("01/01/2005", "%m/%d/%Y")) %>% 
  ggplot(aes(x = date, y = sum, group = geoid, color = above20))+
  geom_line(size = 1, alpha = 0.4)+
  scale_color_manual(name ="Above 20 installation", values = c("red", "black"))+
  xlab("Year") + ylab("Cumulative number of installation") +
  theme_bw() +
  theme(legend.position = c(0.2, 0.7),
        legend.background = element_rect(fill="transparent")) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y")
```


## Residential solar potential (MWh) in Seattle

```{r, dev="svg", fig.height=4}
ggplot(wrk, aes(x = `Income class`, y = `Total MWh`, group = geoid, color = `Income class`)) + 
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) + 
  theme_bw() + theme(legend.position = c(0.7, 0.3),
                     legend.background = element_rect(color = 1))
```

## Residential solar potential (MWh/ household) in Seattle

```{r, dev="svg", fig.height=4}

ggplot(wrk, aes(x = `Income class`, y = `MWh/house hold`, group = geoid, color = `Income class`)) + 
  facet_grid(type ~ own) +
  geom_point(alpha = 0.3, position = position_jitter(width = 0.5, height = 2)) + 
  theme_bw() + theme(legend.position = c(0.2, 0.3),
                     legend.background = element_rect(color = 1))
```


## Histograms of multiple variables 

```{r, fig.height=5}
par(mfrow = c(3,5))
fhist <- fin[, c(-1,-8)]
for(i in 1:length(fhist)){
  hist(fhist[[i]], main= paste("Histogram of\n", names(fhist)[i]),
       xlab= names(fhist)[i], col="gold")
  abline(v = median(fhist[[i]]), col="red", lwd=4)
  text(median(fhist[[i]]), 0, round(median(fhist[[i]]),2), col = "blue")
}
```

## Cor plot

```{r}
fctr <-corrplot(cor(fin[-c(1,2,6,7,8,9)]), method = "ellipse")
```


## Regression

```{r}
reg <- lm(sol_instl ~ .,fin[-c(1,2,6,7,8,9)])
# stepAIC(reg)

summary(lm(formula = sol_instl ~ hu_rnt + hu_med_val + 
             black, data = fin[-c(1, 2, 6, 7, 8, 9)]))
```

## Residual from the OLS 

![Residual mapping](./Figs/Residual.jpg)

## Geographically weighted regression (GWR)
![Residual mapping for GWR](./Figs/Residual-GWR.jpg)

## Geographically weighted impact 
![Rental proportion](./Figs/Rental-w.jpg)

![House median value](./Figs/H-value-w.jpg)

![Black people proportion](./Figs/Black-w.jpg)

## Factor analysis (Parallel screen) 

```{r}
fct <- fin[-c(1,2,6,7,8,9,16)]

fa.parallel(fct,fa="fa",n.iter=50)
```

## Factor analysis (Plot)

```{r}
fa <- fa(fct,nfactors=3,rotate="promax",fm="ml")
factor.plot(fa, labels=rownames(fa$loadings))
```

## Factor analysis (Diagram)

```{r}
fa.diagram(fa,simple=T)
```

## Factor correlation for solar installation

```{r}
dat <- fa$scores
# dim(dat)
# dim(fin)
plot(dat[,1], fin[[16]], xlab = "The 1st factor", ylab = "Solar installation")
```

## Factor regression 
```{r}
summary(lm(fin[[16]] ~ dat[,1] + dat[,2] + dat[,3]))
```

## Kmeans
```{r}
kmeans <- kmeans(dat,center=3)
kmeans$centers # centroids of clusters
table(kmeans$cluster) #number of samples in each cluster
Group1 <- kmeans$centers[1,]
Group2 <- kmeans$centers[2,]
plot(Group1,Group2,type="n")
text(Group1,Group2, labels=colnames(dat))
```

## Cluster within cluster sum of squares (WCSS)

```{r}
set.seed(5099)
sum(kmeans(dat,center=2)$withinss)
wss <- (nrow(dat)-1)*sum(apply(dat,2,var))
for (i in 2:9) wss[i] <- sum(kmeans(dat,centers=i)$withinss)
plot(1:9, wss, type="b", xlab="Number of Clusters",ylab="Within groups sum of squares")
```

## Cluster plot
```{r}
pairs(dat, col=kmeans$cluster)
clusplot(dat, kmeans$cluster, color=TRUE,shade=TRUE, labels=5, lines=0)
```

## 3D plot
```{r}
library(rgl)
plot3d(fa$scores, col = kmeans$cluster)
```

![](./Figs/3D.jpg)

